<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Prioritization of locations for off-grid rural electrification in Tanzania</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/css/leaflet-sidebar.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body>

    <div id='map'></div>

    <div id="progress">
        <div id="progress-bar"></div>
    </div>
    <div id="map"></div>

    <div id="sidebar" class="leaflet-sidebar">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href=#data-sources role="tab"><i class="fa fa-link"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fa fa-filter"></i></a></li>
                <li><a href="#download" role="tab"><i class="fa fa-arrow-circle-down"></i></a></li>

            </ul>
            <ul role="tablist">
                <li><a href="#about" role="tab"><i class="fa fa-question-circle"></i></a></li>
            </ul>
        </div>
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
					 Village priorization in Tanzania
					<div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
				</h1>
                <p>The overall objective of this project is to prioritize locations for off-grid rural electrification in Tanzania. New datasets will be developed that will enable faster and more accurate market analysis for distributed energy services companies (DESCOs) operating in Tanzania, including household locations and indicators on ability to pay, potential for productive uses of electricity and up-to-date data on national electricity grid transmission and distribution line locations. Collectively, it is expected that these datasets will help DESCOs operating in, or seeking to enter, Tanzania to narrow down geographic areas that could be interesting markets for their off-grid energy services. </p>
                <p>This objective will be achieved by a combination of remote sensing, GIS analyses and other data collection. These activities are complemented by stakeholder workshops and local capacity development. </p>
                <span><p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p></span>
            </div>

            <div class="leaflet-sidebar-pane" id="data-sources">
                <h1 class="leaflet-sidebar-header">Data sources<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>The data for the analysis was downloaded form the following sources:</p>
                <p>High Resolution Settlement Layer: <a href="https://ciesin.columbia.edu/data/hrsl/#data" target="_blank">CIESIN</a>.</p>
                <p>Region, District, Ward and Village shapefiles: <a href="http://portal-nbs-tz.opendata.arcgis.com/datasets/" target="_blank">NBS GIS Open Data Portal</a>.</p>
                <p>Global Horizontal Irradiance raster dataset: <a href="http://globalsolaratlas.info/downloads/tanzania" target="_blank">Global Solar Atlas</a>.</p>
                <p>Number of healthsites and water sources dataset: <a href="http://portal-nbs-tz.opendata.arcgis.com/datasets/" target="_blank">NBS GIS Open Data Portal</a>.</p>
                <p>The processing steps for preparing the data for the prioritization are described with details and examples in <a href="methodology_prioritization.html" target="_blank">this section</a>.</p>
                <p>An overview of the web-map development is provided <a href="methodology_webmap.html" target="_blank">here</a>.</p>

            </div>
            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">Filter<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>
                    <h3>Distance to grid (km)</h3> Existing grid infrastructure in close distance can present a risk to mini-grid development, since grid extension may connect those locations to the national grid infrastructure in foreseeable future. Here a minimum distance to the grid can be selected.</p>
                <div id="sliderdist"></div>
                <p>
                    <h3>Population</h3> Attractive mini-grid locations require a minimum number of customers to form an attractive investment. Certain mini-grid solutions target a specific location size. Here a minimum or maximum number of population per cluster can be selected.</p>
                <br>
                <div id="sliderpop"></div>
                <p>
                    <h3>Social infrastucture</h3> Social institutions such as schools, hospitals, public infrastructure or water points can be used as a proxy of socio-economic activity . Here locations without any of those can be excluded.</p>
                <br>
                <label class="switch">
                    <input type="checkbox" id="checkboxinfra">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="leaflet-sidebar-pane" id="about">
                <h1 class="leaflet-sidebar-header">
					 About the map
					<div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
				</h1>
                <p>The web-map was created within the Worldbank/IFC financed project Prioritization of locations for off-grid rural electrification in Tanzania (Selection #1249011). </p>
                <p>It was developed by a consortium of <a href="http://www.integration.org/" target="_blank">Integration Energy and Environment</a>, <a href="http://www.rafikipower.com/" target="_blank">E.ON Off Grid Solutions</a> and <a href="http://reiner-lemoine-institut.de/en/" target="_blank">Reiner Lemoine Institute</a>.</p>
                <p><img src="images/watermark.gif" width="100%" height="auto" alt="Picture not found">
                </p>
                <span><p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p></span>
            </div>
            <div class="leaflet-sidebar-pane" id="download">
                <h1 class="leaflet-sidebar-header">
						Download
						<div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
					</h1>
                <p>Data visualized in the map can be downloaded from <a href="https://energydata.info/dataset/prioritization-of-locations-for-off-grid-rural-electrification-in-tanzania" target="_blank">Energydata.info</a> here. Available formats are geojson, shapefile or csv. </p>
                <span><p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p></span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster-src.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

    <script src="data/points.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/js/leaflet-sidebar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.1.0/wNumb.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.js"></script>

    <script>
        var options = {
                center: [-6, 35],
                zoom: 6,
                minZoom: 6,
                maxZoom: 19,
                zoomControl: false,
                maxBounds: [
                    [-13, 26],
                    [1, 41]
                ]
            },
            map = L.map('map', options);

        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a 	href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var topo = L.tileLayer('http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data: &copy;  <a href="https://opentopomap.org">OpenTopoMap</a> '
        });

        var nl = L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
            attribution: 'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov">ESDIS</a>) with funding provided by NASA/HQ.',
            minZoom: 1,
            maxZoom: 8,
            format: 'jpg',
            time: '',
            tilematrixset: 'GoogleMapsCompatible_Level'
        });

        var ae = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        L.control.scale({
            position: 'bottomright'
        }).addTo(map);

        var baseMaps = {
            "osm": osm,
            "topo": topo,
            "night lights": nl,
            "aerial imagery": ae
        };

        // add village cluster data set

        var vecTileLayer = L.vectorGrid.protobuf("data/tiles/{z}/{x}/{y}.pbf", {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    cluster: function(prop, zoom) {
                        if (prop.Access == "no") {
                            color = "lightgray";
                        } else {
                            color = "red";
                        }
                        return {
                            fill: true,
                            fillColor: color,
                            fillOpacity: 0.5,
                            color: 'gray',
                            weight: 1
                        };
                    },
                    regions: function(prop, zoom) {
                        if (zoom > 7) {
                            return {
                                stroke: false
                            };
                        } else {
                            return {
                                color: 'LightGreen',
                                weight: 5,
                                opacity: 0.3
                            };
                        }
                    },
                    grid: {
                        color: "#ff7800",
                        weight: 2,
                        opacity: 0.85,
                        smoothFactor: 5
                    }
                },
                maxZoom: 15,
                minZoom: 5,
                interactive: true,
                getFeatureId: function(f) {
                    if (f.properties.Access !== undefined) {
                        return "c" + f.properties.ID;
                    }
                    if (f.properties.type !== undefined) {
                        return "g" + f.properties.ID;
                    }
                    return "r" + f.properties.OBJECTID;
                }
            })
            .on('click', function(e) {
                this.clearHighlight(this);
                var properties = e.layer.properties;
                if (properties.Access !== undefined) {
                    type = "c";
                    ID = "c" + properties.ID;
                    popup = `

                        Region: ${properties.Region} <br/>
                        District: ${properties.District} <br/>
                        Village: ${properties.V} <br/>
                        Ward: ${properties.W} <br/>
                        Grid access: ${properties.Access} <br/>
                        ID: ${properties.ID}
						`;
                } else if (properties.type !== undefined) {
                    type = "g";
                    ID = "g" + properties.ID;
                    popup = `
								ID ${properties.ID} <br/> 
								Voltage : ${properties.kV} kV <br/> 
								Source:: ${properties.sources} <br/>
								`;
                } else {
                    type = "r";
                    ID = "r" + properties.OBJECTID;
                }
                if (type != "r") {
                    L.popup()
                        .setContent(popup)
                        .setLatLng(e.latlng)
                        .openOn(map);
                    this.highlight = ID;
                    var style = {
                        fillColor: '#0000FF',
                        fillOpacity: 0.5,
                        stroke: true,
                        fill: true,
                        color: '#0000FF',
                        opacity: 0.5,
                        weight: 2,
                    };

                    this.setFeatureStyle(ID, style);
                    L.DomEvent.stop(e);
                }
            })
        vecTileLayer.highlight = null;
        vecTileLayer.hidden = null;
        vecTileLayer.hiddenstyle = {
            fillColor: 'lightgray',
            fillOpacity: 0.1,
            opacity: 0.1,
            fill: true
        };
        vecTileLayer.clearHidden = function(e) {
            if (e.hidden) {
                for (nid in e.hidden) {
                    var id = e.hidden[nid];
                    e.resetFeatureStyle(id);
                }
            }
        };
        vecTileLayer.clearHighlight = function(e) {
            if (e.highlight) {
                e.resetFeatureStyle(e.highlight);
            }
            e.highlight = null;
            if (e.hidden) {
                for (nid in e.hidden) {
                    var id = e.hidden[nid];
                    e.setFeatureStyle(id, e.hiddenstyle);
                }
            }
        };

        map.addLayer(vecTileLayer);
        map.on('click', function() {
            vecTileLayer.clearHighlight(vecTileLayer)
        });
        map.on('popupclose', function() {
            vecTileLayer.clearHighlight(vecTileLayer)
        });

        //add markercluster
        var markers = L.markerClusterGroup({
            chunkedLoading: true
        });

        //Cluster filter for electrification data
        //(c) F. Zimmermann, 2018
        //Licensed under BSD 3-Clause
        const DIST = 0;
        const POP = 1;
        const INFRA = 2;
        const LONG = 3;
        const LAT = 4;
        const INFO = 5;
        var currentfilter = {
            mindist: 0,
            maxdist: 120,
            minpop: 0,
            maxpop: 20000,
            infra: 0
        };

        markers.filter = function(e, filter, map) {
            e.clearLayers()
            var markerList = [];
            for (var i = 0; i < points.length; i++) {
                var point = points[i];
                if (point[DIST] > filter.mindist && point[DIST] < filter.maxdist && point[POP] > filter.minpop && point[POP] < filter.maxpop && point[INFRA] >= filter.infra) {
                    var info = point[INFO];
                    var title = `ID ${info.ID} <br/> Population: ${info.POP} <br/> Distance to grid: ${info.DIST} km`;
                    var marker = L.marker(L.latLng(point[LAT], point[LONG]), point[INFO]);
                    marker.bindPopup(title);
                    markerList.push(marker);
                }
            }
            e.addLayers(markerList);
            map.addLayer(e);
        };

        vecTileLayer.filter = function(e, filter) {
            e.clearHidden(e);
            var hiddenIDs = []
            var vt = e._vectorTiles;
            for (vtkey in vt) {
                var f = vt[vtkey]._features;
                for (fkey in f) {
                    var prop = f[fkey].feature.properties;
                    if (!(prop.D > filter.mindist && prop.D < filter.maxdist && prop.P > filter.minpop && prop.P < filter.maxpop)) {
                        hiddenIDs.push("c" + prop.ID);
                        e.setFeatureStyle("c" + prop.ID, e.hiddenstyle);
                    }
                }
            }
            e.hidden = hiddenIDs;
        };

        map.addEventListener('filterchange', function(filter) {
            vecTileLayer.filter(vecTileLayer, currentfilter);
            //if (map.hasLayer(markers)){
            markers.filter(markers, currentfilter, map);
            //}
        });

        vecTileLayer.on('load', function() {
            vecTileLayer.filter(vecTileLayer, currentfilter);
        });

        //slider
        noUiSlider.create(sliderpop, {
            start: [currentfilter.minpop, currentfilter.maxpop],
            connect: true,
            step: 100,
            range: {
                'min': currentfilter.minpop,
                'max': currentfilter.maxpop
            },
            format: wNumb({
                decimals: 0,
                thousand: '.'
            }),
            tooltips: true,
            pips: {
                mode: 'range',
                density: 3
            }
        });
        sliderpop.noUiSlider.on('change', function(str, h, values) {
            currentfilter.minpop = values[0];
            currentfilter.maxpop = values[1];
            map.fireEvent('filterchange', currentfilter);
        });

        noUiSlider.create(sliderdist, {
            start: [currentfilter.mindist, currentfilter.maxdist],
            connect: true,
            step: 1,
            range: {
                'min': currentfilter.mindist,
                'max': currentfilter.maxdist
            },
            //            format: wNumb({
            //                decimals: 0,
            //                thousand: '.'
            //            }),
            tooltips: false,
            pips: {
                mode: 'count',
                values: 7,
                density: 4
            }
        });
        sliderdist.noUiSlider.on('change', function(str, h, values) {
            currentfilter.mindist = values[0];
            currentfilter.maxdist = values[1];
            map.fireEvent('filterchange', currentfilter);
        });

        checkboxinfra = document.getElementById('checkboxinfra');
        checkboxinfra.onchange = function(e) {
            currentfilter.infra = e.target.checked;
            setTimeout(function() {
                map.fireEvent('filterchange', currentfilter)
            }, 100);

        };
        //sidebar
        var sidebar = L.control.sidebar({
            container: 'sidebar',
            closeButton: true,
            position: 'left'
        }).addTo(map);

        var overlayMaps = {
            "marker": markers
        };
        L.control.layers(baseMaps, overlayMaps).addTo(map);
        map.fireEvent('filterchange', currentfilter);

        //        //add watermark
        //        L.Control.Watermark = L.Control.extend({
        //            onAdd: function(map) {
        //                var img = L.DomUtil.create('img');
        //                img.src = 'images/watermark.gif';
        //                img.style.width = '350px';
        //                return img;
        //            },
        //            onRemove: function(map) {}
        //        });
        //        L.control.watermark = function(opts) {
        //            return new L.Control.Watermark(opts);
        //        }
        //        L.control.watermark({
        //            position: 'bottomright'
        //        }).addTo(map);
    </script>
</body>

</html>
