<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Prioritization of locations for off-grid rural electrification in Tanzania</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" integrity="sha384-X7L1bhgb36bF1iFvaqvhgpaGpayKM+vXNNYRlF89BFA5s3vi1qZ8EX9086RlZjy1" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" integrity="sha384-lPzjPsFQL6te2x+VxmV6q1DpRxpRk0tmnl2cpwAO5y04ESyc752tnEWPKDfl1olr" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" integrity="sha384-5kMSQJ6S4Qj5i09mtMNrWpSi8iXw230pKU76xTmrpezGnNJQzj0NzXjQLLg+jE7k" crossorigin="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/css/leaflet-sidebar.min.css" integrity="sha384-EPNnjUWfl6+wmqeqVBLV1haeIrms6PXl67DNZ/RVCsfkwT78QX2fe16Gxidc6UOF" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.css" integrity="sha384-FkoYQ3TJKbULb445cDwfaUqQaTntabe5j49blZqESH0tMC1UexckavWD1M68+Y9B" crossorigin="" />
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body>

    <div id="map"></div>
    <div id="sidebar" class="leaflet-sidebar">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href=#data-sources role="tab"><i class="fa fa-link"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fa fa-filter"></i></a></li>
                <li><a href="#download" role="tab"><i class="fa fa-arrow-circle-down"></i></a></li>

            </ul>
            <ul role="tablist">
                <li><a href="#about" role="tab"><i class="fa fa-question-circle"></i></a></li>
            </ul>
        </div>
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
                     Village priorization Tanzania
                    <div class="leaflet-sidebar-close"><i class="fa fa-times"></i></div>
                </h1>
                <p>The overall objective of this project is to prioritize locations for off-grid rural electrification in Tanzania. New datasets will be developed that will enable faster and more accurate market analysis for distributed energy services companies (DESCOs) operating in Tanzania, including household locations and indicators on ability to pay, potential for productive uses of electricity and up-to-date data on national electricity grid transmission and distribution line locations. Collectively, it is expected that these datasets will help DESCOs operating in, or seeking to enter, Tanzania to narrow down geographic areas that could be interesting markets for their off-grid energy services. </p>
                <p>This objective will be achieved by a combination of remote sensing, GIS analyses and other data collection. These activities are complemented by stakeholder workshops and local capacity development. </p>
                
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>

            <div class="leaflet-sidebar-pane" id="data-sources">
                <h1 class="leaflet-sidebar-header">Data sources<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>The data for the analysis was downloaded form the following sources:</p>
                <p>High Resolution Settlement Layer: <a href="https://ciesin.columbia.edu/data/hrsl/#data" target="_blank">CIESIN</a>.</p>
                <p>Region, District, Ward and Village shapefiles: <a href="http://portal-nbs-tz.opendata.arcgis.com/datasets/" target="_blank">NBS GIS Open Data Portal</a>.</p>
                <p>Global Horizontal Irradiance raster dataset: <a href="http://globalsolaratlas.info/downloads/tanzania" target="_blank">Global Solar Atlas</a>.</p>
                <p>Number of healthsites and water sources dataset: <a href="http://portal-nbs-tz.opendata.arcgis.com/datasets/" target="_blank">NBS GIS Open Data Portal</a>.</p>
                <p>The processing steps for preparing the data for the prioritization with details and examples and an overview of the web-map development are described  in <a href="methodology_prioritization.html" target="_blank">this section</a>.</p>
                

            </div>
            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">Filter<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>
                    <h3>Distance to grid (km)</h3> Existing grid infrastructure in close distance can present a risk to mini-grid development, since grid extension may connect those locations to the national grid infrastructure in foreseeable future. Here a minimum distance to the grid can be selected.</p>
                <div id="sliderdist"></div>
                <p>
                    <h3>Population</h3> Attractive mini-grid locations require a minimum number of customers to form an attractive investment. Certain mini-grid solutions target a specific location size. Here a minimum or maximum number of population per cluster can be selected.</p>
                <br>
                <div id="sliderpop"></div>
                <p>
                    <h3>Social infrastucture</h3> Social institutions such as schools, hospitals, public infrastructure or water points can be used as a proxy of socio-economic activity . Here locations without any of those can be excluded.</p>
                <br>
                <label class="switch">
                    <input type="checkbox" id="checkboxinfra">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="leaflet-sidebar-pane" id="about">
                <h1 class="leaflet-sidebar-header">
                     About the map
                    <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                </h1>
                <p>The web-map was created within the Worldbank/IFC financed project Prioritization of locations for off-grid rural electrification in Tanzania (Selection #1249011). </p>
                <p>It was developed by a consortium of <a href="http://www.integration.org/" target="_blank">Integration Energy and Environment</a>, <a href="http://www.rafikipower.com/" target="_blank">E.ON Off Grid Solutions</a> and <a href="http://reiner-lemoine-institut.de/en/" target="_blank">Reiner Lemoine Institute</a>.</p>
                <p><img src="images/watermark.gif" width="100%" height="auto" alt="Picture not found">
                </p>
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
            <div class="leaflet-sidebar-pane" id="download">
                <h1 class="leaflet-sidebar-header">
                        Download
                        <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                    </h1>
                <p>Data visualized in the map can be downloaded from <a href="https://energydata.info/dataset/prioritization-of-locations-for-off-grid-rural-electrification-in-tanzania" target="_blank">Energydata.info</a> here. Available formats are geojson, shapefile or csv. </p>
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster-src.js" integrity="sha384-NAOEbWFcjnXc7U9GkULPhupHZNAbqru9dS3c+4ANYAwtFoVAWuVuMVDH0DIy4ESp" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js" integrity="sha384-FON5fTjCTtPuBgUS1r2H/PGXstH0Rk23YKjZmB6qITkbFqBcqtey/rPo9eXwOWpx" crossorigin=""></script>
    <script src="data/points.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/js/leaflet-sidebar.min.js" integrity="sha384-LzTQ6yhqVy/ipjMq5MMk98mo0E64Wtu9K1Jm5OeKPolnqrlv3FMdc457RoOANGMb" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.1.0/wNumb.min.js" integrity="sha384-9NhfMwMkkA6dDFEyj5CxOiYaL6KqLjKINTJkR7e5SlZthrndR9oB/SJsi5PBNnjw" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.js" integrity="sha384-sxnhs+25aQQN+rABTQEEYOIX5CW20SBJyXt9oGMT5VDacFTTWGXKotTEAe8BUiwb" crossorigin=""></script>

    <script>
        //Cluster filter for electrification data
        //(c) F. Zimmermann, 2018
        //Licensed under BSD 3-Clause

        let options = {
                center: [-6, 35],
                zoom: 6,
                minZoom: 6,
                maxZoom: 15,
                zoomControl: false,
                maxBounds: [
                    [-13, 26],
                    [1, 41]
                ]
            };
        let map = L.map("map", options);

        L.control.zoom({
            position: "topright"
        }).addTo(map);

        let osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let topo = L.tileLayer("http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
        });

        let nl = L.tileLayer("https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}", {
            attribution: 'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov">ESDIS</a>) with funding provided by NASA/HQ.',
            minZoom: 1,
            maxZoom: 8,
            format: "jpg",
            time: "",
            tilematrixset: "GoogleMapsCompatible_Level"
        });

        let ae = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        L.control.scale({
            position: "bottomright"
        }).addTo(map);

        let baseMaps = {
            "OpenStreetMap": osm,
            "OpenTopoMap": topo,
            "Night Lights": nl,
            "Aerial Imagery": ae
        };

        let vecTileLayer = L.vectorGrid.protobuf("data/tiles/{z}/{x}/{y}.pbf", {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    cluster: function(prop, zoom) {
                        if (prop.Access == "no") {
                            color = "lightgray";
                        } else {
                            color = "red";
                        }
                        return {
                            fill: true,
                            fillColor: color,
                            fillOpacity: 0.5,
                            color: "gray",
                            weight: 1
                        };
                    },
                    regions: function(prop, zoom) {
                        if (zoom > 7) {
                            return {
                                stroke: false
                            };
                        } else {
                            return {
                                color: "LightGreen",
                                weight: 5,
                                opacity: 0.3
                            };
                        }
                    },
                    grid: {
                        color: "#ff7800",
                        weight: 2,
                        opacity: 0.85,
                        smoothFactor: 5
                    }
                },
                maxZoom: 15,
                minZoom: 5,
                interactive: true,
                getFeatureId: function(f) {
                    if (f.properties.Access !== undefined) {
                        return f.properties.ID;
                    }
                    if (f.properties.type !== undefined) {
                        return "g" + f.properties.ID;
                    }
                    return "r" + f.properties.OBJECTID;
                }
            })
            .on("click", function(e) {
                this.clearHighlight();
                let properties = e.layer.properties;
                if (properties.Access !== undefined) {
                    var type = "c";
                    var ID = properties.ID;
                    let public=["School","Healthcare","Water Point","Public Building"].filter(function (v,i){i++;return i==properties.SC||i==properties.HC*2||i==properties.WC*3||i==properties.PC*4}).join(",<br/>");
                    public=public||"No Data";
                    var popup=`
                    <table>
                      <tr><td align="right"><b>Region</b>:</td><td>${properties.Region}</td></tr>
                      <tr><td align="right"><b>District</b>:</td><td>${properties.District}</td></tr>
                      <tr><td align="right"><b>Village</b>:</td><td>${properties.V}</td></tr>
                      <tr><td align="right"><b>Ward</b>:</td><td>${properties.W}</td></tr>
                      <tr><td align="right"><b>Grid access</b>:</td><td>${properties.Access}</td></tr>
                      `;
                    if (properties.Access === "no"){
                          popup=popup+`
                          <tr><td align="right"><b>Dist. to Grid</b>:</td><td>${properties.D} km</td></tr>
                          <tr><td align="right"><b>Population</b>:</td><td>${properties.P}</td></tr>
                          <tr><td align="right"><b>Pop. Density</b>:</td><td>${properties.Density}</td></tr>
                          <tr><td align="right"><b>Area</b>:</td><td>${properties.A} km&sup2;</td></tr>
                          <tr><td align="right"><b>Social Infra.</b>:</td><td>${public}</td></tr>
                          <tr><td align="right"><b>Rank</b>:</td><td>${properties.OARank}</td></tr>
                          <tr><td align="right"><b>ID</b>:</td><td>${properties.ID}</td></tr>
                          `;
                    }
                    popup=popup+`
                    </table>
                    `;
                } else if (properties.type !== undefined) {
                    var type = "g";
                    var ID = "g" + properties.ID;
                    var popup = `
                                <b>Voltage</b>: ${properties.kV} kV <br/>
                                <b>Source</b>: ${properties.sources} <br/>
                                <b>ID</b>: ${properties.ID}
                                `;
                } else {
                    var type = "r";
                    var ID = "r" + properties.OBJECTID;
                }
                if (type != "r") {
                    L.popup()
                        .setContent(popup)
                        .setLatLng(e.latlng)
                        .openOn(map);
                    this.highlight = ID;
                    let style = {
                        fillColor: "#0000FF",
                        fillOpacity: 0.5,
                        stroke: true,
                        fill: true,
                        color: "#0000FF",
                        opacity: 0.5,
                        weight: 2
                    };

                    this.setFeatureStyle(ID, style);
                    L.DomEvent.stop(e);
                }
            });
        vecTileLayer.highlight = null;
        vecTileLayer.hidden = null;
        vecTileLayer.hiddenstyle = {
            fillColor: "lightgray",
            fillOpacity: 0.1,
            opacity: 0.1,
            fill: true
        };
        vecTileLayer.clearHidden = function() {
            if (this.hiddenIDs) {
                for (let i = 0, len = this.hiddenIDs.length; i < len; i++) {
                    let id = this.hiddenIDs[i];
                    this.resetFeatureStyle(id);
                }
            }
        };
        vecTileLayer.clearHighlight = function() {
            if (this.highlight) {
                if (this.hiddenIDs && this.hiddenIDs.indexOf(this.highlight) > -1){
                    this.setFeatureStyle(this.highlight, this.hiddenstyle);
                } else {
                    this.resetFeatureStyle(this.highlight);
                }
            }
            this.highlight = null;
        };

        map.addLayer(vecTileLayer);
        map.on("click", function() {
            vecTileLayer.clearHighlight();
        });
        map.on("popupclose", function() {
            vecTileLayer.clearHighlight();
        });

        let markers = L.markerClusterGroup({
            chunkedLoading: true
        });

        const DIST = 0,POP = 1, INFRA = 2,LONG = 3,LAT = 4,INFO = 5;
        let currentfilter = {
            mindist: 0,
            maxdist: 120,
            minpop: 0,
            maxpop: 20000,
            infra: 0
        };

        markers.filter = function(filter, map) {
            this.clearLayers();
            let markerList = [];
            for (let i = 0; i < points.length; i++) {
                let point = points[i];
                if (point[DIST] > filter.mindist && point[DIST] < filter.maxdist && point[POP] > filter.minpop && point[POP] < filter.maxpop && point[INFRA] >= filter.infra) {
                    let info = point[INFO];
                    let title = `
                    <table>
                      <tr><td align="center" colspan="2"><b><u>Priority Cluster</u></b></td></tr>
                      <tr><td align="right"><b>Region</b>:</td><td>${info.R}</td></tr>
                      <tr><td align="right"><b>District</b>:</td><td>${info.D}</td></tr>
                      <tr><td align="right"><b>Village</b>:</td><td>${info.V}</td></tr>
                      <tr><td align="right"><b>Ward</b>:</td><td>${info.W}</td></tr>
                      <tr><td align="right"><b>Grid Access</b>:</td><td>no</td></tr>
                      <tr><td align="right"><b>Dist. to Grid</b>:</td><td>${info.DIST} km</td></tr>
                      <tr><td align="right"><b>Population</b>:</td><td>${info.POP}</td></tr>
                      <tr><td align="right"><b>Pop. Density</b>:</td><td>${info.DENS}/km&sup2;</td></tr>
                      <tr><td align="right"><b>Social Infra.</b>:</td><td>${info.INFRA?"yes":"No Data"}</td></tr>
                      <tr><td align="right"><b>Rank</b>:</td><td>${info.RANK}</td></tr>
                      <tr><td align="right"><b>ID</b>:</td><td>${info.ID}</td></tr>
                    </table>
                    `;
                    let marker = L.marker(L.latLng(point[LAT], point[LONG]), point[INFO]);
                    marker.bindPopup(title);
                    markerList.push(marker);
                }
            }
            this.addLayers(markerList);
            map.addLayer(this);
        };

        vecTileLayer.filter = function(filter) {
            let newhiddenIDs = [];
            let vt = this._vectorTiles;
            for (let vtkey in vt) {
                let f = vt[vtkey]._features;
                for (let fkey in f) {
                    let prop = f[fkey].feature.properties;
                    if (prop.Access=="no"){
                        if (!(prop.D > filter.mindist && prop.D < filter.maxdist && prop.P > filter.minpop && prop.P < filter.maxpop && (prop.HC+prop.SC+prop.WC+prop.PC)>=filter.infra )) {
                            newhiddenIDs.push(prop.ID);
                            this.setFeatureStyle(prop.ID, this.hiddenstyle);
                        } else if (this.hiddenIDs.indexOf(prop.ID) > -1){
                            this.resetFeatureStyle(prop.ID);
                        }
                    }
                }
            }
            this.hiddenIDs = newhiddenIDs;
        };

        map.addEventListener("filterchange", function(filter) {
            vecTileLayer.filter(currentfilter);
            markers.filter(currentfilter, map);
        });

        vecTileLayer.on("load", function(e) {
            vecTileLayer.filter(currentfilter);
        });
        noUiSlider.create(sliderpop, {
            start: [currentfilter.minpop, currentfilter.maxpop],
            connect: true,
            step: 100,
            range: {
                "min": currentfilter.minpop,
                "max": currentfilter.maxpop
            },
            format: wNumb({
                decimals: 0,
                thousand: "."
            }),
            tooltips: true,
            pips: {
                mode: "range",
                density: 3
            }
        });
        sliderpop.noUiSlider.on("change", function(str, h, values) {
            currentfilter.minpop = values[0];
            currentfilter.maxpop = values[1];
            map.fireEvent("filterchange", currentfilter);
        });

        noUiSlider.create(sliderdist, {
            start: [currentfilter.mindist, currentfilter.maxdist],
            connect: true,
            step: 1,
            range: {
                "min": currentfilter.mindist,
                "max": currentfilter.maxdist
            },
            //            format: wNumb({
            //                decimals: 0,
            //                thousand: "."
            //            }),
            tooltips: false,
            pips: {
                mode: "count",
                values: 7,
                density: 4
            }
        });
        sliderdist.noUiSlider.on("change", function(str, h, values) {
            currentfilter.mindist = values[0];
            currentfilter.maxdist = values[1];
            map.fireEvent("filterchange", currentfilter);
        });

        checkboxinfra = document.getElementById("checkboxinfra");
        checkboxinfra.onchange = function(e) {
            currentfilter.infra = e.target.checked;
            setTimeout(function() {
                map.fireEvent("filterchange", currentfilter);
            }, 100);

        };

        let sidebar = L.control.sidebar({
            container: "sidebar",
            closeButton: true,
            position: "left"
        }).addTo(map);

        let overlayMaps = {
            "Priority Clusters": markers
        };
        L.control.layers(baseMaps, overlayMaps).addTo(map);
        map.on("layeradd",function (){vecTileLayer.bringToFront();});
        map.fireEvent("filterchange", currentfilter);

        //        //add watermark
        //        L.Control.Watermark = L.Control.extend({
        //            onAdd: function(map) {
        //                let img = L.DomUtil.create('img');
        //                img.src = 'images/watermark.gif';
        //                img.style.width = '350px';
        //                return img;
        //            },
        //            onRemove: function(map) {}
        //        });
        //        L.control.watermark = function(opts) {
        //            return new L.Control.Watermark(opts);
        //        }
        //        L.control.watermark({
        //            position: 'bottomright'
        //        }).addTo(map);
    </script>
</body>

</html>
