<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Population cluster for electrification in Nigeria</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" integrity="sha384-X7L1bhgb36bF1iFvaqvhgpaGpayKM+vXNNYRlF89BFA5s3vi1qZ8EX9086RlZjy1" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" integrity="sha384-lPzjPsFQL6te2x+VxmV6q1DpRxpRk0tmnl2cpwAO5y04ESyc752tnEWPKDfl1olr" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" integrity="sha384-5kMSQJ6S4Qj5i09mtMNrWpSi8iXw230pKU76xTmrpezGnNJQzj0NzXjQLLg+jE7k" crossorigin="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/css/leaflet-sidebar.min.css" integrity="sha384-EPNnjUWfl6+wmqeqVBLV1haeIrms6PXl67DNZ/RVCsfkwT78QX2fe16Gxidc6UOF" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.css" integrity="sha384-FkoYQ3TJKbULb445cDwfaUqQaTntabe5j49blZqESH0tMC1UexckavWD1M68+Y9B" crossorigin="" />
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body>

    <div id="map"></div>
    <div id="sidebar" class="leaflet-sidebar">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href=#data-sources role="tab"><i class="fa fa-link"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fa fa-filter"></i></a></li>
                <li><a href="#download" role="tab"><i class="fa fa-arrow-circle-down"></i></a></li>

            </ul>
            <ul role="tablist">
                <li><a href="#about" role="tab"><i class="fa fa-question-circle"></i></a></li>
            </ul>
        </div>
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
                     Population cluster in Nigeria
                    <div class="leaflet-sidebar-close"><i class="fa fa-times"></i></div>
                </h1>
                <p>This tool was developed to get an overview on current levels of village electrification in Nigeria and to quickly and accurately prioritize villages by their potential for off-grid electrification, based on information such as population density, distance to grid, solar resource and others. </p>
				<p>The menu on the left provides access to further information about the tool, links to data sources and outputs, and filters to refine the results displayed in the tool.</p>
				<p>In addition to this tool, detailed household level maps are being created selected village cluster in rural Nigeria. This data will become visible in this tool as it is created and added to <a href="https://www.openstreetmap.org/search?query=tanzania#map=6/-6.402/34.993" target="_blank">OpenStreetMap</a>.</p>
				<p>This tool is developed by the <a href="https://reiner-lemoine-institut.de/" target="_blank">Reiner Lemoine Institut</a> and <a href="http://integration.org/" target="_blank">INTEGRATION environment and energy</a> for GIZ Nigeria on behalf of Nigerias Federal Ministry of Power Works and Housing.
                
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>

            <div class="leaflet-sidebar-pane" id="data-sources">
                <h1 class="leaflet-sidebar-header">Data sources<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p><h3>Access input data</h3>
				The data for the analysis was downloaded form the following sources:
				High Resolution Settlement Layer: <a href="https://ciesin.columbia.edu/data/hrsl/#data" target="_blank">CIESIN</a>.<br>
                Region, District, Ward and Village shapefiles: <a href="https://data.humdata.org/dataset/nga-administrative-boundaries" target="_blank">HDX Humdata</a>.<br>
                Global Horizontal Irradiance raster dataset: <a href="http://globalsolaratlas.info/downloads/tanzania" target="_blank">Global Solar Atlas</a>.<br>
                Number of healthsites and water sources dataset: <a href="https://data.humdata.org/dataset/nga-administrative-boundaries" target="_blank">HDX Humdata</a>.<br>
                The processing steps for preparing the data for the prioritization are described with details and examples in <a href="methodology_prioritization.html" target="_blank">this section</a>.</p>
				<p><h3>Methodology for data preparation</h3> 
                An overview of the web-map development is provided <a href="methodology_webmap.html" target="_blank">here</a>.</p>
                

            </div>
            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">Filter<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                 <h3>Cluster Area</h3> Use this to filter the results by area in km2<br>
                <div id="sliderarea"></div>
                    //<h3>Population range</h3> Use this to filter the results to a desired population range. Note that this data may not agree with the latest census data.
                //<br>
                //<div id="sliderpop"></div>
                
				
				<!-- <h3>Multi-criteria ranking</h3> Each village is ranked based on a number of criteria. This can be adjusted by downloading the complete data as a CSV file from the menu and choosing a ranking that suits your needs, but here a quick overview is given. It ranges from 0.01 to 0.25 and combined the above described criteria and ranks the villages according to their scoring.
                <br> -->
            </div>
            <div class="leaflet-sidebar-pane" id="about">
                <h1 class="leaflet-sidebar-header">
                     About the map
                    <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                </h1>
               <p>Source code for the webmap can be found <a href="https://github.com/catcad/maptz" target="_blank">here</a>.</p>
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
            <div class="leaflet-sidebar-pane" id="download">
                <h1 class="leaflet-sidebar-header">
                        Download
                        <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                    </h1>
                <p>Some of the visualized data in this tool can be downloaded here. This will allow complete exploration, and filtering villages and results much more freely. Available formats are GeoJSON, Shapefile or CSV. </p>
                
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
		<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster-src.js" integrity="sha384-NAOEbWFcjnXc7U9GkULPhupHZNAbqru9dS3c+4ANYAwtFoVAWuVuMVDH0DIy4ESp" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js" integrity="sha384-FON5fTjCTtPuBgUS1r2H/PGXstH0Rk23YKjZmB6qITkbFqBcqtey/rPo9eXwOWpx" crossorigin=""></script>
    <!-- <script src="data/points.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/js/leaflet-sidebar.min.js" integrity="sha384-LzTQ6yhqVy/ipjMq5MMk98mo0E64Wtu9K1Jm5OeKPolnqrlv3FMdc457RoOANGMb" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.1.0/wNumb.min.js" integrity="sha384-9NhfMwMkkA6dDFEyj5CxOiYaL6KqLjKINTJkR7e5SlZthrndR9oB/SJsi5PBNnjw" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.js" integrity="sha384-sxnhs+25aQQN+rABTQEEYOIX5CW20SBJyXt9oGMT5VDacFTTWGXKotTEAe8BUiwb" crossorigin=""></script>

    <script>
        //Cluster filter for electrification data
        //(c) F. Zimmermann, 2018
        //Licensed under BSD 3-Clause

        let options = {
                center: [9, 7],
                zoom: 7,
                minZoom: 6,
                maxZoom: 15,
                zoomControl: false,
                maxBounds: [
                    [2, 15],
                    [14, 0]
                ]
            };
        let map = L.map("map", options);

        L.control.zoom({
            position: "topright"
        }).addTo(map);

        let osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let topo = L.tileLayer("http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
        });

        let nl = L.tileLayer("https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}", {
            attribution: 'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov">ESDIS</a>) with funding provided by NASA/HQ.',
            minZoom: 1,
            maxZoom: 8,
            format: "jpg",
            time: "",
            tilematrixset: "GoogleMapsCompatible_Level"
        });

        let ae = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        L.control.scale({
            position: "bottomright"
        }).addTo(map);

        let baseMaps = {
            "OpenStreetMap": osm,
            "OpenTopoMap": topo,
            "Night Lights": nl,
            "Aerial Imagery": ae
        };

        let vecTileLayer = L.vectorGrid.protobuf("https://www.zimf.de/mbtileserver/services/nesp/tiles/{z}/{x}/{y}.pbf", {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    ng_cluster_attr: function(prop, zoom) {
                        if (prop.FID > 0) {
                            color = "red";
                        } else {
                            color = "lightgrey";
                        }
                        return {
                            fill: true,
                            fillColor: color,
                            fillOpacity: 0.2,
                            color: "red",
                            weight: 1
                        };
                    },
                    regions: function(prop, zoom) {
                        if (zoom > 7) {
                            return {
                                stroke: false
                            };
                        } else {
                            return {
                                color: "LightGreen",
                                weight: 5,
                                opacity: 0.3
                            };
                        }
                    },
                    kedco_lines: {
                        color: "#ff7800",
                        weight: 2,
                        opacity: 0.85,
                        smoothFactor: 5
                    }
                },
                maxZoom: 15,
                minZoom: 5,
                interactive: true,
                getFeatureId: function(f) {
                    if (f.properties.FID !== undefined) {
                        return f.properties.FID;
                    }
                    if (f.properties.osm_id !== undefined) {
                        return "g" + f.properties.osm_id;
                    }
                    return "r" + f.properties.OBJECTID;
                }
            })
            .on("click", function(e) {
                console.log('click')
                this.clearHighlight();
                let properties = e.layer.properties;
                console.log(properties)
                if (properties.FID !== undefined) {
                    var type = "c";
                    var ID = properties.FID;
                    var popup='\
                    <table>\
                      <tr><td align="right"><b>Admin1</b>:</td><td>'+properties.admin1+'</td></tr>\
                      <tr><td align="right"><b>Admin2</b>:</td><td>'+properties.admin2+'</td></tr>\
                      <tr><td align="right"><b>Area</b>:</td><td>'+parseFloat(properties.area_km2).toFixed(2)+' km2</td></tr>\
                      <tr><td align="right"><b>Population</b>:</td><td>'+parseFloat(properties.pop_hrsl).toFixed(0)+'</td></tr>\
                    </table>';
                } else if (properties.osm_id !== undefined) {
                    var type = "g";
                    var ID = "g" + properties.osm_id;
                    var popup = '\
                                <b>Voltage</b>: '+properties.voltage+' kV <br/>\
                                <b>Operator</b>: '+properties.operator+'<br/>\
                                ';
                } else {
                    var type = "r";
                    var ID = "r" + properties.OBJECTID;
                }
                if (type != "r") {
                    L.popup()
                        .setContent(popup)
                        .setLatLng(e.latlng)
                        .openOn(map);
                    this.highlight = ID;
                    let style = {
                        fillColor: "#0000FF",
                        fillOpacity: 0.5,
                        stroke: true,
                        fill: true,
                        color: "#0000FF",
                        opacity: 0.5,
                        weight: 2
                    };

                    this.setFeatureStyle(ID, style);
                    L.DomEvent.stop(e);
                }
            });
        vecTileLayer.highlight = null;
        vecTileLayer.hidden = null;
        vecTileLayer.hiddenstyle = {
            fillColor: "lightgray",
            fillOpacity: 0.3,
            opacity: 0,
            fill: true,
            color: "lightgray"
        };
        vecTileLayer.clearHidden = function() {
            if (this.hiddenIDs) {
                for (let i = 0, len = this.hiddenIDs.length; i < len; i++) {
                    let id = this.hiddenIDs[i];
                    this.resetFeatureStyle(id);
                }
            }
        };
        vecTileLayer.clearHighlight = function() {
            if (this.highlight) {
                if (this.hiddenIDs && this.hiddenIDs.indexOf(this.highlight) > -1){
                    this.setFeatureStyle(this.highlight, this.hiddenstyle);
                } else {
                    this.resetFeatureStyle(this.highlight);
                }
            }
            this.highlight = null;
        };

        map.addLayer(vecTileLayer);
        map.on("click", function() {
            vecTileLayer.clearHighlight();
        });
        map.on("popupclose", function() {
            vecTileLayer.clearHighlight();
        });

        // let markers = L.markerClusterGroup({
        //     chunkedLoading: true
        // });

        // const AREA = 0,POP = 1,LONG = 3,LAT = 4,INFO = 5;
        let currentfilter = {
            minarea: 0.01,
            maxarea: 50,
            minpop: 0,
            maxpop: 20000,
        };

        // markers.filter = function(filter, map) {
        //     this.clearLayers();
        //     let markerList = [];
        //     for (let i = 0; i < points.length; i++) {
        //         let point = points[i];
        //         if (point[AREA] > filter.minarea && point[AREA] < filter.maxarea && point[POP] > filter.minpop && point[POP] < filter.maxpop) {
        //             let info = point[INFO];
        //             let title = '\
        //             <table>\
        //               <tr><td align="center" colspan="2"><b><u>Priority Cluster</u></b></td></tr>\
        //               <tr><td align="right"><b>Region</b>:</td><td>'+info.R+'</td></tr>\
        //               <tr><td align="right"><b>District</b>:</td><td>'+info.D+'</td></tr>\
        //               <tr><td align="right"><b>Village</b>:</td><td>'+info.V+'</td></tr>\
        //               <tr><td align="right"><b>Ward</b>:</td><td>'+info.W+'</td></tr>\
        //               <tr><td align="right"><b>Grid Access</b>:</td><td>no</td></tr>\
        //               <tr><td align="right"><b>Dist. to Grid</b>:</td><td>'+info.DIST+' km</td></tr>\
        //               <tr><td align="right"><b>Population</b>:</td><td>'+info.POP+'</td></tr>\
        //               <tr><td align="right"><b>Pop. Density</b>:</td><td>'+info.DENS+'/km&sup2;</td></tr>\
        //               <tr><td align="right"><b>Social Infra.</b>:</td><td>'+(info.INFRA?'yes':'No Data')+'</td></tr>\
        //               <tr><td align="right"><b>Rank</b>:</td><td>'+info.RANK+'</td></tr>\
        //               <tr><td align="right"><b>ID</b>:</td><td>'+info.ID+'</td></tr>\
        //             </table>';
        //             let marker = L.marker(L.latLng(point[LAT], point[LONG]), point[INFO]);
        //             marker.bindPopup(title);
        //             markerList.push(marker);
        //         }
        //     }
        //     this.addLayers(markerList);
        //     map.addLayer(this);
        // };

        vecTileLayer.filter = function(filter) {
            let newhiddenIDs = [];
            let vt = this._vectorTiles;
            for (let vtkey in vt) {
                let f = vt[vtkey]._features;
                for (let fkey in f) {
                    
                    let prop = f[fkey].feature.properties;
                    if (typeof prop.area_km2 !== 'undefined'){
                        if (!(prop.area_km2 > filter.minarea && prop.area_km2 < filter.maxarea && prop.pop_hrsl > filter.minpop && prop.pop_hrsl < filter.maxpop)) {
                            newhiddenIDs.push(prop.FID);
                            if (this.hiddenIDs.indexOf(prop.FID) == -1){
                                this.setFeatureStyle(prop.FID, this.hiddenstyle);
                            }
                        } else if (this.hiddenIDs.indexOf(prop.FID) > -1){
                            this.resetFeatureStyle(prop.FID);
                        }
                    }
                }
            }
            this.hiddenIDs = newhiddenIDs;
        };

        map.addEventListener("filterchange", function(filter) {
            vecTileLayer.filter(currentfilter);
            // markers.filter(currentfilter, map);
        });

        vecTileLayer.on("load", function(e) {
            vecTileLayer.filter(currentfilter);
        });
        let logFormat = function(decimals){
            return wNumb({
                decimals: decimals,
                thousand: ",",
                encoder: function(val){
                    return Math.pow(10,val);
                },
                decoder: function(val){
                    return Math.log10(val);
                }
            })
        };

        //noUiSlider.create(sliderpop, {
          //start: [currentfilter.minpop, currentfilter.maxpop],
            //connect: true,
            //range: {
                //"min": Math.log10(currentfilter.minpop),
                //max": Math.log10(currentfilter.maxpop)
            //},
            //format: logFormat(0),
            //tooltips: true,
            //pips: {
            //    mode: 'range',
            //    density: 3
            //}
		//	pips: {
                //format: logFormat(0),
                //mode: "count",
                //values: Math.log10(currentfilter.maxpop)-Math.log10(currentfilter.minpop)+1,
                //density: 100
            //}
        //});
        //sliderpop.noUiSlider.on("change", function(str, h, values) {
            //currentfilter.minpop = Math.pow(10,values[0]);
            //currentfilter.maxpop = Math.pow(10,values[1]);
            //map.fireEvent("filterchange", currentfilter);
        //});

        noUiSlider.create(sliderarea, {
            start: [currentfilter.minarea, currentfilter.maxarea],
            connect: true,
            range: {
                "min": Math.log10(currentfilter.minarea),
                "max": Math.log10(currentfilter.maxarea)
            },
            format: logFormat(2),
            tooltips: true,
            pips: {
                format: logFormat(2),
                mode: "count",
                values: Math.log10(currentfilter.maxarea)-Math.log10(currentfilter.minarea)+1,
                density: 100
            }
        });
        sliderarea.noUiSlider.on("change", function(str, h, values) {
            currentfilter.minarea = Math.pow(10,values[0]);
            currentfilter.maxarea = Math.pow(10,values[1]);
            map.fireEvent("filterchange", currentfilter);
        });

        // checkboxinfra = document.getElementById("checkboxinfra");
        // checkboxinfra.onchange = function(e) {
        //     currentfilter.infra = e.target.checked;
        //     setTimeout(function() {
        //         map.fireEvent("filterchange", currentfilter);
        //     }, 100);

        // };

        let sidebar = L.control.sidebar({
            container: "sidebar",
            closeButton: true,
            position: "left"
        }).addTo(map);

        let overlayMaps = {
            // "Priority Clusters": markers
        };
        L.control.layers(baseMaps, overlayMaps).addTo(map);
        map.on("layeradd",function (){vecTileLayer.bringToFront();});
        map.fireEvent("filterchange", currentfilter);

        //        //add watermark
        //        L.Control.Watermark = L.Control.extend({
        //            onAdd: function(map) {
        //                let img = L.DomUtil.create('img');
        //                img.src = 'images/watermark.gif';
        //                img.style.width = '350px';
        //                return img;
        //            },
        //            onRemove: function(map) {}
        //        });
        //        L.control.watermark = function(opts) {
        //            return new L.Control.Watermark(opts);
        //        }
        //        L.control.watermark({
        //            position: 'bottomright'
        //        }).addTo(map);
    </script>
</body>

</html>
